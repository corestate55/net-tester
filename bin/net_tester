#!/usr/bin/env ruby
# frozen_string_literal: true
$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'rubygems'
require 'bundler'
Bundler.setup :default

require 'gli'
require 'net_tester/command'

module NetTester
  # net_tester command
  module App
    extend GLI::App

    desc 'Runs NetTester'
    command :run do |c|
      c.desc 'number of virtual hosts'
      c.flag [:n, :nhost]
      c.desc 'device name that virtual hosts use'
      c.flag [:D, :device]
      c.desc 'VLAN ID set to each host'
      c.flag [:vlan]

      c.action do |_global_options, options, _args|
        raise '--nhost option is mandatory' if options[:nhost].nil?
        raise '--device option is mandatory' if options[:device].nil?

        exit_now!('NetTester is already running') if Command.running?

        Command.run options[:nhost].to_i, options[:vlan]
        Command.connect_switch(device: options[:device], port_number: options[:nhost].to_i + 1)
      end
    end

    desc 'Add a patch'
    command :add do |c|
      c.desc 'port number of virtual switch'
      c.flag [:vport]
      c.desc 'port number of physical switch'
      c.flag [:port]

      c.action do |_global_options, options, _args|
        raise '--vport option is mandatory' if options[:vport].nil?
        raise '--port option is mandatory' if options[:port].nil?

        exit_now!('NetTester is not running') unless Command.running?

        Command.add options[:vport].to_i, options[:port].to_i
      end
    end

    desc 'List patches'
    command :list do |c|
      c.action do |_global_options, _options, _args|
        p Command.list
      end
    end

    desc 'Send packet'
    command :send_packet do |c|
      c.desc 'host that sends packets'
      c.flag [:s, :source]
      c.desc 'host that receives packets'
      c.flag [:d, :dest]

      c.action do |_global_options, options, _args|
        raise '--source option is mandatory' if options[:source].nil?
        raise '--dest option is mandatory' if options[:dest].nil?

        Command.send_packet options[:source], options[:dest]
      end
    end

    desc 'Show received packets'
    arg_name 'host'
    command :stats do |c|
      c.action do |_golbal_options, _options, args|
        help_now!('host is required') if args.empty?

        host = args.first
        unless NetTester::Host.find_by(name: host)
          exit_now! %(#{host}: no such host)
        end

        sent_desc = ''
        NetTester::Host.all.each do |each|
          next if host == each.name
          npacket = Command.packets_sent(host, each.name)
          sent_desc += "  #{host} -> #{each.name} = #{npacket} packet" if npacket > 0
        end
        puts "Packets sent:\n#{sent_desc}" unless sent_desc.empty?

        received_desc = ''
        NetTester::Host.all.each do |each|
          next if host == each.name
          npacket = Command.packets_received(host, each.name)
          received_desc += "  #{each.name} -> #{host} = #{npacket} packet" if npacket > 0
        end
        puts "Packets received:\n#{received_desc}" unless received_desc.empty?
      end
    end

    desc 'Kills NetTester'
    command :kill do |c|
      c.action do |_global_options, _options, _args|
        Command.kill
      end
    end

    exit run(ARGV)
  end
end
